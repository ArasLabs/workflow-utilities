<AML>
 <Item type="Method" id="96142798436345C3877F1CD739DE5A3E" action="add">
  <comments>use with LifeCycle (post) transition or Worflow (post) path server events</comments>
  <execution_allowed_to keyed_name="World" type="Identity">A73B655731924CD0B027E4F4D5FCC0A9</execution_allowed_to>
  <method_code><![CDATA[' called from LifeCycle of thisItem or Workflow(Activity) of thisItem
Dim thisId As String = Me.GetID()
Dim thisType As String = Me.GetType()
Dim q As item
Dim res As Item
Dim wfProcessItem As Item = Nothing
'System.Diagnostics.Debugger.Break()

Dim wfControlledItem As Item
' if this Item is type "Activity" the method was called from the Workflow Process
If thisType = "Activity" Then
  q = Me.newItem("Workflow Process Activity","get")
  q.setAttribute("select","source_id(name)")
  q.setProperty("related_id",thisId)
  res = q.apply()
  If res.isError() Then Return res

  Dim wfProcessId As String = res.getItembyIndex(0).getProperty("source_id","")
  
  Dim amlCmd As String = ""
  amlCmd = amlCmd & "<Item type='Workflow' action='get' select='source_type,source_id(owned_by_id),related_id(*)'>"
  amlCmd = amlCmd & "<related_id>" & wfProcessId & "</related_id>"
  amlCmd = amlCmd & "<source_id condition='is not null'/>"
  amlCmd = amlCmd & "</Item>"
  q = Me.newItem("","")
  q.loadAML(amlCmd)
  res = q.apply()
  If res.isError() Then Return res

  wfProcessItem = res.getItemByIndex(0).getPropertyItem("related_id")
  
  amlCmd = "<Item type='" & res.getItemByIndex(0).getPropertyAttribute("source_type","keyed_name","") & "' action='get' select='owned_by_id'>"
  amlCmd = amlCmd & "<id>" & res.getItemByIndex(0).getProperty("source_id","invalid") & "</id>"
  amlCmd = amlCmd & "</Item>"
  q = Me.newItem("","")
  q.loadAML(amlCmd) 
  wfControlledItem = q.apply()
  If wfControlledItem.isError() Then Return wfControlledItem
  
Else
  wfControlledItem = Me

  'get the workflow process of this item
  q = Me.newItem("Workflow","get")
  q.setAttribute("select","related_id(*)")
  q.setProperty("source_id",thisId)
  res = q.apply()
  If res.isError() Then Return res

  If res.getProperty("related_id","") <> "" Then
    wfProcessItem = res.getItemByIndex(0).getPropertyItem("related_id")
  End If

End If

If Not isNothing(wfProcessItem) Then

  Dim changeOwner As String = wfControlledItem.getProperty("owned_by_id","")

  If changeOwner = "" Then Return Me ' noting to do

  wfProcessItem.setProperty("managed_by_id",changeOwner)
  ' call other method
  
  ' run as Super User identity 
  Dim plmIdentity As Aras.Server.Security.Identity  = Aras.Server.Security.Identity.GetByName("Super User")
  Dim PermissionWasSet As Boolean  = Aras.Server.Security.Permissions.GrantIdentity(plmIdentity)

  wfProcessItem = wfProcessItem.apply("WorkflowProcess_UpdateManager")

  ' Revoke 'Aras PLM' permissions
  If (PermissionWasSet) Then Aras.Server.Security.Permissions.RevokeIdentity(plmIdentity)
  If wfProcessItem.isError() Then Return wfProcessItem
End If
Return  Me]]></method_code>
  <method_type>VB</method_type>
  <name>CopyChangeOwnerToWorkflow</name>
 </Item>
</AML>